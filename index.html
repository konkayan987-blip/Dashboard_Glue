<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glue Usage & Cost Analytics</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr (‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Sarabun:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', 'Sarabun', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #f8fafc;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .kpi-value { font-size: 1.5rem; font-weight: 700; }
        @media (min-width: 1024px) { .kpi-value { font-size: 1.75rem; } }
        .kpi-label { font-size: 0.875rem; color: #94a3b8; font-weight: 500; }
        .kpi-sub { font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-[1400px] mx-auto space-y-6">
        
        <!-- Header & Filter -->
        <header class="glass-card rounded-2xl p-6 flex flex-col xl:flex-row justify-between items-center gap-4 border-l-4 border-l-emerald-500">
            <div>
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400">
                    üõ¢Ô∏è Glue Usage Analytics
                </h1>
                <p class="text-slate-400 text-sm mt-1">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
            </div>
            
            <!-- Date Filter -->
            <div class="flex flex-wrap items-center gap-3 bg-slate-900/50 p-3 rounded-xl border border-slate-700">
                <div class="flex items-center gap-2">
                    <label class="text-sm text-slate-300">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà:</label>
                    <input type="text" id="startDate" class="bg-slate-800 border border-slate-600 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-emerald-500 text-white w-28 text-center placeholder-slate-400">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm text-slate-300">‡∏ñ‡∏∂‡∏á:</label>
                    <input type="text" id="endDate" class="bg-slate-800 border border-slate-600 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-emerald-500 text-white w-28 text-center placeholder-slate-400">
                </div>
                <button onclick="applyFilter()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-1.5 rounded-lg text-sm font-semibold transition duration-200 shadow-lg shadow-emerald-500/30">
                    üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button onclick="resetFilter()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-1.5 rounded-lg text-sm font-semibold transition duration-200">
                    ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                </button>
                <button onclick="loadData()" id="refreshBtn" class="bg-teal-600 hover:bg-teal-500 text-white px-4 py-1.5 rounded-lg text-sm font-semibold transition duration-200 shadow-lg shadow-teal-500/30 flex items-center gap-2">
                    <i class="fa-solid fa-arrows-rotate"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </header>

        <!-- KPI Summary Cards (7 Cards) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            
            <div class="glass-card rounded-2xl p-5 relative overflow-hidden">
                <div class="absolute top-4 right-4 text-emerald-400 opacity-20"><i class="fa-solid fa-flask text-3xl"></i></div>
                <div class="kpi-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°</div>
                <div id="kpiTotalUsage" class="kpi-value text-emerald-400 mt-2">--</div>
                <div class="kpi-sub">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (kg)</div>
            </div>

            <div class="glass-card rounded-2xl p-5 relative overflow-hidden">
                <div class="absolute top-4 right-4 text-rose-400 opacity-20"><i class="fa-solid fa-money-bill-wave text-3xl"></i></div>
                <div class="kpi-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏ß‡∏£‡∏ß‡∏°</div>
                <div id="kpiTotalCost" class="kpi-value text-rose-400 mt-2">--</div>
                <div class="kpi-sub">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏ö‡∏≤‡∏ó (Baht)</div>
            </div>

            <div class="glass-card rounded-2xl p-5 relative overflow-hidden">
                <div class="absolute top-4 right-4 text-blue-400 opacity-20"><i class="fa-solid fa-box-open text-3xl"></i></div>
                <div class="kpi-label">‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏° (Output)</div>
                <div id="kpiTotalOutput" class="kpi-value text-blue-400 mt-2">--</div>
                <div class="kpi-sub">‡∏´‡∏ô‡πà‡∏ß‡∏¢: Output / ‡∏ä‡∏¥‡πâ‡∏ô</div>
            </div>

            <div class="glass-card rounded-2xl p-5 relative overflow-hidden">
                <div class="absolute top-4 right-4 text-amber-400 opacity-20"><i class="fa-solid fa-chart-pie text-3xl"></i></div>
                <div class="kpi-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏ø / Output</div>
                <div id="kpiAvgRatio" class="kpi-value text-amber-400 mt-2">--</div>
                <div class="kpi-sub">‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ú‡∏•‡∏¥‡∏ï</div>
            </div>

            <div class="glass-card rounded-2xl p-5 relative overflow-hidden border-b-2 border-b-purple-500/50">
                <div class="absolute top-4 right-4 text-purple-400 opacity-20"><i class="fa-solid fa-layer-group text-3xl"></i></div>
                <div class="kpi-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏Å‡∏£‡∏±‡∏° / ‡∏ï‡∏£‡∏°.</div>
                <div id="kpiGramSqm" class="kpi-value text-purple-400 mt-2">--</div>
                <div class="kpi-sub">g/Sqm (‡∏ô‡πâ‡∏≠‡∏¢=‡∏î‡∏µ)</div>
            </div>

            <div class="glass-card rounded-2xl p-5 relative overflow-hidden border-b-2 border-b-pink-500/50">
                <div class="absolute top-4 right-4 text-pink-400 opacity-20"><i class="fa-solid fa-weight-scale text-3xl"></i></div>
                <div class="kpi-label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏Å‡∏£‡∏±‡∏° / Output</div>
                <div id="kpiGramOutput" class="kpi-value text-pink-400 mt-2">--</div>
                <div class="kpi-sub">g/Output (‡∏ô‡πâ‡∏≠‡∏¢=‡∏î‡∏µ)</div>
            </div>
            
            <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏ß -->
            <div class="glass-card rounded-2xl p-5 relative overflow-hidden border-b-2 border-b-violet-500/50">
                <div class="absolute top-4 right-4 text-violet-400 opacity-20"><i class="fa-solid fa-percent text-3xl"></i></div>
                <div class="kpi-label">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏ß</div>
                <div id="kpiQuality" class="kpi-value text-violet-400 mt-2">--</div>
                <div class="kpi-sub">% ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
            </div>
        </div>

        <!-- Charts Row 1: Bar Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="glass-card rounded-2xl p-6 border-t-2 border-emerald-500/50">
                <h3 class="text-lg font-semibold mb-4 text-emerald-300">üìä ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (kg)</h3>
                <div class="w-full h-[250px]"><canvas id="barUsage"></canvas></div>
            </div>
            <div class="glass-card rounded-2xl p-6 border-t-2 border-rose-500/50">
                <h3 class="text-lg font-semibold mb-4 text-rose-300">üí∞ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏ß (Baht)</h3>
                <div class="w-full h-[250px]"><canvas id="barCost"></canvas></div>
            </div>
            <div class="glass-card rounded-2xl p-6 border-t-2 border-purple-500/50">
                <h3 class="text-lg font-semibold mb-4 text-purple-300">üìê ‡∏Å‡∏£‡∏±‡∏° / ‡∏ï‡∏£‡∏°. (g/Sqm)</h3>
                <div class="w-full h-[250px]"><canvas id="barGramSqm"></canvas></div>
            </div>
        </div>

        <!-- Charts Row 2: Trend Lines -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 text-amber-300">üìâ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤ (‡∏ø / Output)</h3>
                <div class="w-full h-[250px]"><canvas id="trendRatio"></canvas></div>
            </div>
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 text-purple-300">üìâ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° ‡∏Å‡∏£‡∏±‡∏° / ‡∏ï‡∏£‡∏°. (g/Sqm)</h3>
                <div class="w-full h-[250px]"><canvas id="trendGramSqm"></canvas></div>
            </div>
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 text-pink-300">üìâ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° ‡∏Å‡∏£‡∏±‡∏° / Output</h3>
                <div class="w-full h-[250px]"><canvas id="trendGramOutput"></canvas></div>
            </div>
        </div>
        
        <!-- Charts Row 3: Quality Trend (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà) -->
        <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 text-violet-300">üß™ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏ß (%)</h3>
                <div class="w-full h-[250px]"><canvas id="trendQuality"></canvas></div>
            </div>
        </div>

    </div>

<script>
    // URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏≤‡∏ß (‡∏°‡∏µ &gid=483689587 ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
    const sheetUrl = "https://docs.google.com/spreadsheets/d/1B9zHhiB0lknlC94yd7r6hV_Wzn7xlnqvT1cx6aidoSQ/export?format=csv&gid=483689587";

    let allData = [];
    let filteredData = [];
    let charts = {};

    const colors = {
        iso: { border: '#f43f5e', bg: 'rgba(244, 63, 94, 0.6)' },   // Rose (ISOWA)
        bhs: { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.6)' },  // Blue (BHS)
        yue: { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.6)' }   // Amber (YUELI)
    };

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Flatpickr ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£)
    flatpickr("#startDate", { dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y" });
    flatpickr("#endDate", { dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y" });

    Chart.defaults.color = '#94a3b8';
    Chart.defaults.font.family = "'Inter', 'Sarabun', sans-serif";

    const parseNum = (val) => parseFloat(val?.replace(/,/g, "")) || 0;

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏µ ‡∏û.‡∏®. (‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏•‡∏≤‡∏î)
    function parseDateString(dateStr) {
        if (!dateStr) return 0;
        const cleanStr = dateStr.replace(/\uFEFF/g, '').replace(/"/g, '').trim().split(' ')[0];
        
        // ‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ / ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ
        const parts = cleanStr.split('/');
        if (parts.length === 3) {
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // JS ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0
            let year = parseInt(parts[2].substring(0, 4), 10);
            
            if (year > 2500) year -= 543; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®. ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
            
            return new Date(year, month, day).getTime(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Timestamp ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
        }
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà / ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏õ‡∏•‡∏á
        let d = new Date(cleanStr);
        if (!isNaN(d.getTime())) return d.getTime();
        
        return 0;
    }

    function loadData() {
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fa-solid fa-arrows-rotate fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            refreshBtn.disabled = true;
        }

        allData = [];

        fetch(sheetUrl)
            .then(res => res.text())
            .then(csv => {
                // üö® ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (csv.toLowerCase().includes("<html") || csv.toLowerCase().includes("sign in")) {
                    alert("üö® ‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ!\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Google Sheets ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡πÅ‡∏ä‡∏£‡πå (Share) ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô ‡πÄ‡∏õ‡πá‡∏ô '‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå' (Anyone with the link) ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                    resetBtnState();
                    return;
                }

                const rows = csv.trim().split("\n");
                if (rows.length < 2) return;

                // üåü ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                let header = rows[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/"/g, '').trim().toLowerCase());
                let getIdx = (k1, k2, defaultIdx) => {
                    let idx = header.findIndex(x => x.includes(k1) && (x.includes(k2) || x.includes('isowa')));
                    return idx !== -1 ? idx : defaultIdx;
                };

                let col = {
                    yue_u: getIdx('‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì', 'yue', 4),
                    yue_c: getIdx('‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏ß', 'yue', 5),
                    yue_o: getIdx('output', 'yue', 6),
                    yue_sqm: getIdx('sqm', 'yue', -1), 
                    
                    bhs_u: getIdx('‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì', 'bhs', 10),
                    bhs_c: getIdx('‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏ß', 'bhs', 11),
                    bhs_o: getIdx('output', 'bhs', 12),
                    bhs_sqm: getIdx('sqm', 'bhs', -1), 
                    
                    iso_u: getIdx('‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì', 'iso', 15),
                    iso_c: getIdx('‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏ß', 'iso', 16),
                    iso_o: getIdx('output', 'iso', 17),
                    iso_sqm: getIdx('sqm', 'iso', -1),
                    
                    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏ß‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
                    quality: header.findIndex(x => x.includes('‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û') || x.includes('%') || x.includes('solid') || x.includes('‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå'))
                };
                
                rows.forEach((r, idx) => {
                    if(idx === 0) return; 
                    
                    const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/"/g, '').trim());
                    if (c.length < 5 || !c[0] || c[0].toLowerCase().includes('total') || c[0] === '') return;

                    const ts = parseDateString(c[0]);
                    if (!ts) return; 

                    const dObj = new Date(ts);
                    const formattedDate = `${String(dObj.getDate()).padStart(2, '0')}/${String(dObj.getMonth() + 1).padStart(2, '0')}/${dObj.getFullYear()}`;

                    allData.push({
                        dateStr: formattedDate, timestamp: ts,
                        yue_usage: parseNum(c[col.yue_u]), yue_cost: parseNum(c[col.yue_c]), yue_out: parseNum(c[col.yue_o]), yue_sqm: col.yue_sqm !== -1 ? parseNum(c[col.yue_sqm]) : 0,
                        bhs_usage: parseNum(c[col.bhs_u]), bhs_cost: parseNum(c[col.bhs_c]), bhs_out: parseNum(c[col.bhs_o]), bhs_sqm: col.bhs_sqm !== -1 ? parseNum(c[col.bhs_sqm]) : 0,
                        iso_usage: parseNum(c[col.iso_u]), iso_cost: parseNum(c[col.iso_c]), iso_out: parseNum(c[col.iso_o]), iso_sqm: col.iso_sqm !== -1 ? parseNum(c[col.iso_sqm]) : 0,
                        quality: col.quality !== -1 ? parseNum(c[col.quality]) : 0
                    });
                });

                if (allData.length === 0) {
                    alert("‚ö†Ô∏è ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!");
                    resetBtnState();
                    return;
                }

                // üö® ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                let totalUsageSum = allData.reduce((acc, d) => acc + d.yue_usage + d.bhs_usage + d.iso_usage, 0);
                if (totalUsageSum === 0) {
                    alert(`‚ö†Ô∏è ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÑ‡∏î‡πâ ${allData.length} ‡∏ß‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç 0 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!`);
                }

                allData.sort((a, b) => a.timestamp - b.timestamp);

                if (allData.length > 0) {
                    const minDate = new Date(allData[0].timestamp);
                    const maxDate = new Date(allData[allData.length - 1].timestamp);
                    
                    const fp1 = document.getElementById('startDate')._flatpickr;
                    const fp2 = document.getElementById('endDate')._flatpickr;
                    
                    if (fp1 && fp1.selectedDates.length === 0) fp1.setDate(minDate);
                    if (fp2 && fp2.selectedDates.length === 0) fp2.setDate(maxDate);
                }

                applyFilterLogic();
                resetBtnState();
            })
            .catch(err => {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + err.message);
                resetBtnState();
            });
            
        function resetBtnState() {
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                refreshBtn.disabled = false;
            }
        }
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
    loadData();

    function applyFilterLogic() {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (Flatpickr) ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á string
        const fpStart = document.getElementById('startDate')._flatpickr;
        const fpEnd = document.getElementById('endDate')._flatpickr;

        let startTimestamp = 0;
        let endTimestamp = Infinity;

        if (fpStart && fpStart.selectedDates && fpStart.selectedDates.length > 0) {
            const sDate = fpStart.selectedDates[0];
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ
            startTimestamp = new Date(sDate.getFullYear(), sDate.getMonth(), sDate.getDate()).getTime();
        }
        
        if (fpEnd && fpEnd.selectedDates && fpEnd.selectedDates.length > 0) {
            const eDate = fpEnd.selectedDates[0];
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 23:59:59 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
            endTimestamp = new Date(eDate.getFullYear(), eDate.getMonth(), eDate.getDate(), 23, 59, 59).getTime();
        }

        filteredData = allData.filter(d => d.timestamp >= startTimestamp && d.timestamp <= endTimestamp);
        processDashboard();
    }

    function applyFilter() { applyFilterLogic(); }

    function resetFilter() {
        if(allData.length > 0) {
            const fp1 = document.getElementById('startDate')._flatpickr;
            const fp2 = document.getElementById('endDate')._flatpickr;
            if(fp1) fp1.setDate(new Date(allData[0].timestamp));
            if(fp2) fp2.setDate(new Date(allData[allData.length-1].timestamp));
        }
        applyFilterLogic();
    }

    function processDashboard() {
        let sum = {
            iso_usage: 0, iso_cost: 0, iso_out: 0, iso_sqm: 0,
            bhs_usage: 0, bhs_cost: 0, bhs_out: 0, bhs_sqm: 0,
            yue_usage: 0, yue_cost: 0, yue_out: 0, yue_sqm: 0,
            quality: 0, q_count: 0
        };

        filteredData.forEach(d => {
            sum.iso_usage += d.iso_usage; sum.iso_cost += d.iso_cost; sum.iso_out += d.iso_out; sum.iso_sqm += d.iso_sqm;
            sum.bhs_usage += d.bhs_usage; sum.bhs_cost += d.bhs_cost; sum.bhs_out += d.bhs_out; sum.bhs_sqm += d.bhs_sqm;
            sum.yue_usage += d.yue_usage; sum.yue_cost += d.yue_cost; sum.yue_out += d.yue_out; sum.yue_sqm += d.yue_sqm;
            if(d.quality > 0) { sum.quality += d.quality; sum.q_count++; }
        });

        const totalUsage = sum.iso_usage + sum.bhs_usage + sum.yue_usage;
        const totalCost = sum.iso_cost + sum.bhs_cost + sum.yue_cost;
        const totalOutput = sum.iso_out + sum.bhs_out + sum.yue_out;
        const totalSqm = sum.iso_sqm + sum.bhs_sqm + sum.yue_sqm;
        
        const avgRatio = totalOutput > 0 ? (totalCost / totalOutput) : 0;
        const avgGramSqm = totalSqm > 0 ? ((totalUsage * 1000) / totalSqm) : 0;
        const avgGramOutput = totalOutput > 0 ? ((totalUsage * 1000) / totalOutput) : 0;

        const safeDiv = (a, b) => b > 0 ? (a / b) : 0;

        const kpi = {
            iso: { name: 'ISOWA', usage: sum.iso_usage, cost: sum.iso_cost, ratio: safeDiv(sum.iso_cost, sum.iso_out), gSqm: safeDiv(sum.iso_usage * 1000, sum.iso_sqm), gOut: safeDiv(sum.iso_usage * 1000, sum.iso_out) },
            bhs: { name: 'BHS', usage: sum.bhs_usage, cost: sum.bhs_cost, ratio: safeDiv(sum.bhs_cost, sum.bhs_out), gSqm: safeDiv(sum.bhs_usage * 1000, sum.bhs_sqm), gOut: safeDiv(sum.bhs_usage * 1000, sum.bhs_out) },
            yue: { name: 'YUELI', usage: sum.yue_usage, cost: sum.yue_cost, ratio: safeDiv(sum.yue_cost, sum.yue_out), gSqm: safeDiv(sum.yue_usage * 1000, sum.yue_sqm), gOut: safeDiv(sum.yue_usage * 1000, sum.yue_out) }
        };

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        document.getElementById('kpiTotalUsage').innerText = totalUsage.toLocaleString(undefined, {maximumFractionDigits:0});
        document.getElementById('kpiTotalCost').innerText = "‡∏ø" + totalCost.toLocaleString(undefined, {maximumFractionDigits:0});
        document.getElementById('kpiTotalOutput').innerText = totalOutput.toLocaleString(undefined, {maximumFractionDigits:0});
        document.getElementById('kpiAvgRatio').innerText = "‡∏ø " + avgRatio.toFixed(3);
        
        document.getElementById('kpiGramSqm').innerText = avgGramSqm > 0 ? avgGramSqm.toFixed(2) : "0.00";
        document.getElementById('kpiGramOutput').innerText = avgGramOutput > 0 ? avgGramOutput.toFixed(2) : "0.00";
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏ß
        const avgQuality = sum.q_count > 0 ? (sum.quality / sum.q_count) : 0;
        document.getElementById('kpiQuality').innerText = avgQuality > 0 ? avgQuality.toFixed(2) + "%" : "--";

        // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü ‡πÅ‡∏ñ‡∏ß 1 (Bar Charts)
        updateBarChart('barUsage', '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏ß (kg)', [kpi.iso.usage, kpi.bhs.usage, kpi.yue.usage]);
        updateBarChart('barCost', '‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏ß (Baht)', [kpi.iso.cost, kpi.bhs.cost, kpi.yue.cost]);
        updateBarChart('barGramSqm', '‡∏Å‡∏£‡∏±‡∏° / ‡∏ï‡∏£‡∏°. (g/Sqm)', [kpi.iso.gSqm, kpi.bhs.gSqm, kpi.yue.gSqm]);
        
        // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü ‡πÅ‡∏ñ‡∏ß 2 (Trend Lines)
        updateTrendRatioChart();
        updateTrendGramSqmChart();
        updateTrendGramOutputChart();
        
        // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü ‡πÅ‡∏ñ‡∏ß 3 (Quality Chart)
        updateTrendQualityChart();
    }

    function updateBarChart(canvasId, label, dataArr) {
        if(charts[canvasId]) charts[canvasId].destroy();
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['ISOWA', 'BHS', 'YUELI'],
                datasets: [{
                    label: label,
                    data: dataArr,
                    backgroundColor: [colors.iso.bg, colors.bhs.bg, colors.yue.bg],
                    borderColor: [colors.iso.border, colors.bhs.border, colors.yue.border],
                    borderWidth: 2, borderRadius: 8
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: { callbacks: { label: (ctx) => ` ${ctx.raw.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` } }
                },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // ‡∏Å‡∏£‡∏≤‡∏ü Trend ‡∏ø/Output
    function updateTrendRatioChart() {
        if(charts['trendRatio']) charts['trendRatio'].destroy();
        const ctx = document.getElementById('trendRatio').getContext('2d');
        const labels = filteredData.map(d => d.dateStr);
        const calcDailyKPI = (cost, out) => out > 0 ? (cost / out) : null;
        
        charts['trendRatio'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ISOWA', data: filteredData.map(d => calcDailyKPI(d.iso_cost, d.iso_out)), borderColor: colors.iso.border, backgroundColor: 'transparent', tension: 0.3, pointRadius: 3, spanGaps: true },
                    { label: 'BHS', data: filteredData.map(d => calcDailyKPI(d.bhs_cost, d.bhs_out)), borderColor: colors.bhs.border, backgroundColor: 'transparent', tension: 0.3, pointRadius: 3, spanGaps: true },
                    { label: 'YUELI', data: filteredData.map(d => calcDailyKPI(d.yue_cost, d.yue_out)), borderColor: colors.yue.border, backgroundColor: 'transparent', tension: 0.3, pointRadius: 3, spanGaps: true }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top', labels: { color: '#f8fafc', usePointStyle: true, boxWidth: 8 } } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true },
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } }
                }
            }
        });
    }

    // ‡∏Å‡∏£‡∏≤‡∏ü Trend ‡∏Å‡∏£‡∏±‡∏° / SQM
    function updateTrendGramSqmChart() {
        if(charts['trendGramSqm']) charts['trendGramSqm'].destroy();
        const ctx = document.getElementById('trendGramSqm').getContext('2d');
        const labels = filteredData.map(d => d.dateStr);
        const calcGramSqm = (usage, sqm) => sqm > 0 ? ((usage * 1000) / sqm) : null;
        
        charts['trendGramSqm'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ISOWA', data: filteredData.map(d => calcGramSqm(d.iso_usage, d.iso_sqm)), borderColor: colors.iso.border, backgroundColor: 'transparent', tension: 0.3, pointRadius: 4, spanGaps: true },
                    { label: 'BHS', data: filteredData.map(d => calcGramSqm(d.bhs_usage, d.bhs_sqm)), borderColor: colors.bhs.border, backgroundColor: 'transparent', tension: 0.3, pointRadius: 4, spanGaps: true },
                    { label: 'YUELI', data: filteredData.map(d => calcGramSqm(d.yue_usage, d.yue_sqm)), borderColor: colors.yue.border, backgroundColor: 'transparent', tension: 0.3, pointRadius: 4, spanGaps: true }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { position: 'top', labels: { color: '#f8fafc', usePointStyle: true, boxWidth: 8 } },
                    tooltip: { callbacks: { label: (ctx) => ` ${ctx.dataset.label}: ${ctx.raw ? ctx.raw.toFixed(2) + ' g/Sqm' : 'N/A'}` } }
                },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true },
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } }
                }
            }
        });
    }

    // ‡∏Å‡∏£‡∏≤‡∏ü Trend ‡∏Å‡∏£‡∏±‡∏° / Output
    function updateTrendGramOutputChart() {
        if(charts['trendGramOutput']) charts['trendGramOutput'].destroy();
        const ctx = document.getElementById('trendGramOutput').getContext('2d');
        const labels = filteredData.map(d => d.dateStr);
        const calcGramOut = (usage, out) => out > 0 ? ((usage * 1000) / out) : null;
        
        charts['trendGramOutput'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ISOWA', data: filteredData.map(d => calcGramOut(d.iso_usage, d.iso_out)), borderColor: colors.iso.border, backgroundColor: 'transparent', tension: 0.3, pointRadius: 4, spanGaps: true },
                    { label: 'BHS', data: filteredData.map(d => calcGramOut(d.bhs_usage, d.bhs_out)), borderColor: colors.bhs.border, backgroundColor: 'transparent', tension: 0.3, pointRadius: 4, spanGaps: true },
                    { label: 'YUELI', data: filteredData.map(d => calcGramOut(d.yue_usage, d.yue_out)), borderColor: colors.yue.border, backgroundColor: 'transparent', tension: 0.3, pointRadius: 4, spanGaps: true }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { position: 'top', labels: { color: '#f8fafc', usePointStyle: true, boxWidth: 8 } },
                    tooltip: { callbacks: { label: (ctx) => ` ${ctx.dataset.label}: ${ctx.raw ? ctx.raw.toFixed(2) + ' g/Out' : 'N/A'}` } }
                },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true },
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } }
                }
            }
        });
    }
    
    // ‡∏Å‡∏£‡∏≤‡∏ü Trend % ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏ß
    function updateTrendQualityChart() {
        if(charts['trendQuality']) charts['trendQuality'].destroy();
        const ctx = document.getElementById('trendQuality').getContext('2d');
        const labels = filteredData.map(d => d.dateStr);
        
        charts['trendQuality'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { 
                        label: '% ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', 
                        data: filteredData.map(d => d.quality > 0 ? d.quality : null), 
                        borderColor: '#8b5cf6', // Violet
                        backgroundColor: 'rgba(139, 92, 246, 0.1)', 
                        fill: true,
                        tension: 0.3, 
                        pointRadius: 4, 
                        spanGaps: true 
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top', labels: { color: '#f8fafc', usePointStyle: true, boxWidth: 8 } } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: false },
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } }
                }
            }
        });
    }
</script>

</body>
</html>